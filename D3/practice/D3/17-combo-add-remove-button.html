<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <title>Scales</title>

    <script type="text/javascript" src="d3.js"></script>

    <style>

    </style>

</head>

<body>

<button id="add-value-button" type="button">Add value</button>
<button id="remove-value-button" type="button">Remove value</button>

<script type="text/javascript">
    "use strict";
    // DATA ////////////////////////////////////////////////

    var dataset = [ { key: 0, value: 5 },		//dataset is now an array of objects.
        { key: 1, value: 10 },		            //Each object has a 'key' and a 'value'.
        { key: 2, value: 13 },
        { key: 3, value: 19 },
        { key: 4, value: 21 },
        { key: 5, value: 25 },
        { key: 6, value: 22 },
        { key: 7, value: 18 },
        { key: 8, value: 15 },
        { key: 9, value: 13 },
        { key: 10, value: 11 },
        { key: 11, value: 12 },
        { key: 12, value: 15 },
        { key: 13, value: 20 },
        { key: 14, value: 18 },
        { key: 15, value: 17 },
        { key: 16, value: 16 },
        { key: 17, value: 18 },
        { key: 18, value: 23 },
        { key: 19, value: 25 } ];


    // PARAMS ////////////////////////////////////////////////

    var canvasHeight = 250;
    var canvasWidth =  600;


    // SCALES ////////////////////////////////////////////////

    var xScale = d3.scaleBand()
        .domain(d3.range(dataset.length))  // creates [1, 2, 3, 4 ... 24, 25]
        .rangeRound([0, canvasWidth])
        .paddingInner(0.05);


    var yScale = d3.scaleLinear()
        .domain([0, d3.max(dataset, function (d) { return d.value; })])
        .range([0, canvasHeight]);



    // CANVAS  //////////////////////////////////////////////

    var svg = d3.select('body')
        .append('svg')
        .attr('width', canvasWidth)
        .attr('height', canvasHeight);



    // BARS  //////////////////////////////////////////////

    var bars = svg
        .selectAll('rect')
        .data(dataset, function (d) { return d.key; })
        .enter()
        .append('rect')
        .attr('x', function (d, i) {
            return xScale(i);  // return the position of each element in the xScale
        })
        .attr('y', function(d){
            return canvasHeight-yScale(d.value);
        })
        .attr('width', xScale.bandwidth())  // return the bar width
        .attr('height', function (d) {
            return yScale(d.value);
        })
        .attr('fill', function (d) {
            return 'rgb(0,0,' + Math.round(d.value * 10) + ')';
        });


    // LABELS //////////////////////////////////////////////

    var labels =
        svg
        .selectAll('text')
        .data(dataset, function (d) { return d.key })
        .enter()
        .append('text')
        .text(function (d) {
            return d.value
        })
        .attr('x', function (d, i) {
            return xScale(i) + xScale.bandwidth() / 2
        })
        .attr('y', function (d) {
            return canvasHeight - yScale(d.value) + 14
        })
        .attr('font-family', 'sans-serif')
        .attr('font-size', '11px')
        .attr('fill', 'white')
        .attr('text-anchor', 'middle');


    // COMBO ADD/REMOVE VALUE BUTTON //////////////////////////////////////

    d3.selectAll('button')
        .on('click', function () {

            var clickedButtonId = d3.select(this)
                                  .attr('id');


            // If add button is clicked
            if (clickedButtonId === 'add-value-button'){

                // Add a new random number to the dataset
                var maxValue = 25;
                var newValue = Math.floor(Math.random() * maxValue);
                var lastKey = dataset[dataset.length - 1].key;
                var newKey = lastKey + 1;
                dataset.push({key:newKey, value: newValue});

            }

            // If remove button is clicked
            else if (clickedButtonId === 'remove-value-button') {

                // Remove one element form the dataset
                dataset.shift();


                // Bind the new dataset to elements
                var bars = svg.selectAll('rect')
                    .data(dataset, function (d) { return d.key });


                // Remove the bar that does not have data bound to it
                bars
                    .exit()
                    .transition()
                    .attr('y', canvasHeight)
                    .remove();


                // Rebind data to the labels
                var labels = svg
                    .selectAll('text')
                    .data(dataset, function (d) { return d.key });  // update & bind new data to existing and new text elements

                // Remove the label that belongs to the removed bar
                labels
                    .exit()
                    .transition()
                    .attr('y', canvasHeight + 25)
                    .remove();

            }

            // Update the domain of the X scale
            var xScale = d3.scaleBand()
                .domain(d3.range(dataset.length))  // creates [1, 2, 3, 4 ... 24, 25]
                .rangeRound([0, canvasWidth])
                .paddingInner(0.1);

            // Update the domain of the Y scale
            // - Prior to this point, the domain max was set to the max value in the static dataset: 25
            var yScale = d3.scaleLinear()
                .domain([0, d3.max(dataset, function (d) { return d.value })])
                .rangeRound([0, canvasHeight]);


            var bars = svg
                .selectAll('rect')
                .data(dataset, function (d) { return d.key });


            // Update all rects
            bars.enter()          // 'enter' selection for bars
                .append('rect')
                .attr('x', canvasWidth)
                .attr('y', function (d) {
                    return canvasHeight - yScale(d.value);
                })
                .attr('width', xScale.bandwidth())
                .attr('height', function (d) {
                    return yScale(d.value);
                })
                .attr('fill', function (d) {
                    return 'rgb(0,0,' + Math.round(yScale(d.value) * 10) + ')';
                })
                .merge(bars)      // select all bars
                .transition()
                .attr('x', function (d, i) {
                    return xScale(i);
                })
                .attr('width', xScale.bandwidth())
                .attr('fill', function (d) {
                    return 'rgb(0,0,' + d.value * 10 + ')';
                });


            // Update all labels
            var labels = svg
                .selectAll('text')
                .data(dataset, function (d) { return d.key });  // update & bind new data to existing and new text elements

            labels
                .enter()        // select the 'enter' selection
                .append('text') // add new text element(s)
                .text(function (d) {
                    return d.value
                })
                .attr('x', canvasWidth)
                .attr('y', function (d) {
                    return canvasHeight - yScale(d.value)
                })
                //     .attr('fill', 'white')
                .attr('font-family', 'sans-serif')
                .attr('font-size', '11px')
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .merge(labels)
                .transition()
                .attr('x', function (d, i) {
                    return xScale(i) + xScale.bandwidth() / 2
                })
                .attr('y', function (d) {
                    return canvasHeight - yScale(d.value) + 14
                })
                .attr('opacity', function (d) {  // hide labels if there are too many columns
                    if (dataset.length > 42) {
                        return 0
                    }
                    else {
                        return 1
                    }
                })

        });


</script>

</body>

</html>